<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>tamayoke2</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
  html,body{height:100%;margin:0;background:#070b16;color:#fff;font-family:"Noto Sans JP",sans-serif;}
  #stage{position:relative;height:100vh;display:flex;align-items:center;justify-content:center;}
  canvas#g{image-rendering:pixelated;box-shadow:0 0 0 1px #223;}
  .leaderboard{
    position:absolute;top:12px;right:12px;width:260px;height:240px;padding:8px;
    border:1px solid #334;background:rgba(0,0,0,.35);
    font:14px "Orbitron",monospace;white-space:pre;overflow:auto;color:#fff;
  }
  .brand{position:fixed;left:12px;bottom:12px;font:12px monospace;color:#9cf;}
  .boot{position:fixed;left:12px;top:12px;background:rgba(0,0,0,.45);border:1px solid #334;
        padding:6px 8px;font:12px/1.4 monospace;color:#9cf;max-width:48vw;white-space:pre-wrap}
</style>
</head>
<body>
  <div id="stage">
    <canvas id="g" width="960" height="540"></canvas>
    <pre id="ui-leaderboard" class="leaderboard">未設定</pre>
  </div>
  <div class="brand">tamayoke2</div>
  <pre id="bootlog" class="boot">boot…</pre>

<script>
/* ==========================================================
   tamayoke2 — 単一ファイル拡張版
   ・外部JS/設定に依存しない（1ファイル完結）
   ・PNGがあれば使用：assets/…
       - assets/player/player.png
       - assets/bg/layer1.png, layer2.png, layer3.png（任意）
       - assets/bullets/{white,red,blue,kanji}.png
     無ければすべて自動フォールバック描画
   ・BGM（WebAudio自作パッド・クロスフェード）＆効果音
   ・GASランキングは直指定。初回は必ず送信
   ========================================================== */

// ★毎回変える（キャッシュ破り表示用）
const V = "oneshot-20250825-ultimate-3";

// ★あなたの GAS /exec（直指定）
const RANK_ENDPOINT = "https://script.google.com/macros/s/AKfycbxvQ-miSQfyYy2fEmeNstkb-WiHMtTeuJjl2KzuklxYc1UOeytF6F-O1KX1waNZ8QUO2w/exec";

// ---- 便利ログ（左上） ----
const blog = document.getElementById("bootlog");
function bl(msg){ blog.textContent += "\n" + msg; }

window.addEventListener("DOMContentLoaded", () => boot().catch(e=>{bl("BOOT ERROR: "+e.message); console.error(e);} ));

async function boot(){
  bl("V="+V);

  // ---------- Canvas ----------
  const canvas = document.getElementById("g");
  if(!canvas) throw new Error("#g canvas not found");
  const ctx = canvas.getContext("2d");
  const W=canvas.width, H=canvas.height;

  function fit(){ const s=Math.min(innerWidth/W, innerHeight/H); canvas.style.width=`${(W*s)|0}px`; canvas.style.height=`${(H*s)|0}px`; }
  addEventListener("resize",fit); fit();

  // ---------- 画像ローダ（任意） ----------
  const IMG = new Map();
  async function loadImage(url){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=url; }); }
  async function tryLoad(key,url){ try{ const img=await loadImage(url); IMG.set(key,img); bl("img ok: "+url); }catch{ bl("img miss: "+url); } }
  await Promise.all([
    tryLoad("player","assets/player/player.png"),
    tryLoad("bg1","assets/bg/layer1.png"),
    tryLoad("bg2","assets/bg/layer2.png"),
    tryLoad("bg3","assets/bg/layer3.png"),
    tryLoad("b_white","assets/bullets/white.png"),
    tryLoad("b_red","assets/bullets/red.png"),
    tryLoad("b_blue","assets/bullets/blue.png"),
    tryLoad("b_kanji","assets/bullets/kanji.png"),
  ]);

  // ---------- ランキング ----------
  const elLB = document.getElementById("ui-leaderboard");
  class Rank {
    constructor(endpoint){ this.endpoint=String(endpoint||"").trim(); this.enabled=!!this.endpoint; }
    async top(){ if(!this.enabled) return {status:"disabled",rows:[]};
      const r=await fetch(this.endpoint+"?action=top",{cache:"no-store"}); if(!r.ok) throw new Error("HTTP "+r.status);
      const arr=await r.json(); return {status:"ok",rows:Array.isArray(arr)?arr:[]}; }
    async submit(name, score){
      if(!this.enabled) return {status:"disabled"};
      const body=new URLSearchParams({name:String(name||"YOU").slice(0,16),score:String(Math.max(0,score|0)),_ua:navigator.userAgent.slice(0,64)});
      const r=await fetch(this.endpoint,{method:"POST",body}); if(!r.ok) return {status:"error",error:"HTTP "+r.status};
      const d=await r.json().catch(()=>({})); return d&&d.ok?{status:"ok"}:{status:"error",error:d?.error||"unknown"};
    }
  }
  const rank = new Rank(RANK_ENDPOINT);

  async function renderLeaderboard(){
    if(!elLB) return;
    if(!rank.enabled){ elLB.textContent="未設定"; return; }
    elLB.textContent="LOADING...";
    try{
      const {status,rows}=await rank.top();
      if(status!=="ok"){ elLB.textContent="通信エラー"; return; }
      const lines=(rows||[]).slice(0,10).map((r,i)=>{
        const no=String(i+1).padStart(2,"0");
        const name=String(r.name||"").slice(0,10).padEnd(10," ");
        const sc=String(Number(r.score)||0).padStart(6," ");
        return `${no}. ${name}  ${sc}`;
      });
      elLB.textContent=lines.length?lines.join("\n"):"まだスコアがありません";
    }catch(e){ console.error(e); elLB.textContent="通信エラー"; }
  }
  if(rank.enabled){ bl("endpoint="+rank.endpoint); await renderLeaderboard(); } else { bl("endpoint=(empty) → 未設定"); }

  // ---------- ローカル保存 ----------
  const loadPlayerName = () => localStorage.getItem("playerName") || "";
  const savePlayerName = n => localStorage.setItem("playerName", String(n||"").slice(0,16));
  const loadBest = () => Number(localStorage.getItem("bestScore")||"0")|0;
  const saveBest = v => localStorage.setItem("bestScore", String(v|0));

  // ---------- 入力 ----------
  const keys=new Set(); let pointerDown=false, pointerX=W/2, pointerY=H*0.75;
  addEventListener("keydown",e=>{ if(!e.repeat) keys.add(e.key);
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  });
  addEventListener("keyup",e=>keys.delete(e.key));
  function cpos(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left)*W/r.width, y:(e.clientY-r.top)*H/r.height}; }
  canvas.addEventListener("pointerdown",e=>{ pointerDown=true; const p=cpos(e); pointerX=p.x; pointerY=p.y; unlockAudio(); });
  addEventListener("pointerup",()=> pointerDown=false);
  canvas.addEventListener("pointermove",e=>{ if(!pointerDown) return; const p=cpos(e); pointerX=p.x; pointerY=p.y; });

  // ---------- オーディオ（BGM/SE 内製） ----------
  let AC=null, master=null, unlocked=false;
  function makeAC(){ AC=new (window.AudioContext||window.webkitAudioContext)(); master=AC.createGain(); master.connect(AC.destination); master.gain.value=0.9; }
  async function unlockAudio(){ if(unlocked) return; if(!AC) makeAC(); try{ await AC.resume(); unlocked=(AC.state==="running"); }catch{} }

  // タイトル/プレイの簡易パッド
  const pads = {
    title: { osc:null, gain:null, f: 220, lfoF:0.2 },
    play : { osc:null, gain:null, f: 330, lfoF:0.4 }
  };
  function padStart(which){
    if(!AC) return;
    const p = pads[which]; if(!p || p.osc) return;
    const o = AC.createOscillator(); o.type="sawtooth"; o.frequency.value=p.f;
    const g = AC.createGain(); g.gain.value=0;
    const lfo=AC.createOscillator(); const lfoGain=AC.createGain();
    lfo.frequency.value=p.lfoF; lfoGain.gain.value=30; lfo.connect(lfoGain).connect(o.frequency);
    o.connect(g).connect(master); o.start(); lfo.start();
    p.osc=o; p.gain=g; p._lfo=lfo; p._lfoG=lfoGain;
  }
  function padStop(which){
    const p=pads[which]; if(!p||!p.osc) return;
    try{ p.osc.stop(); p._lfo.stop(); }catch{}
    p.osc.disconnect(); p._lfo.disconnect(); p._lfoG.disconnect(); p.gain.disconnect();
    p.osc=p.gain=p._lfo=p._lfoG=null;
  }
  function padCrossTo(which, ms=400){
    if(!AC) return;
    const now=AC.currentTime, dur=Math.max(0.01, ms/1000);
    Object.keys(pads).forEach(k=>{
      const p=pads[k];
      if(!p.osc && k!==which) return;
      padStart(k);
      const tgt = (k===which) ? 0.5 : 0.0;
      p.gain.gain.setValueAtTime(p.gain.gain.value, now);
      p.gain.gain.linearRampToValueAtTime(tgt, now+dur);
      if(k!==which) setTimeout(()=>padStop(k), ms+60);
    });
  }
  // 効果音
  function beep(hz=880, ms=120, vol=0.25){
    if(!AC) return;
    const o=AC.createOscillator(); o.type="square"; o.frequency.value=hz;
    const g=AC.createGain(); g.gain.value=vol; o.connect(g).connect(master); o.start();
    const now=AC.currentTime; g.gain.setValueAtTime(vol, now); g.gain.linearRampToValueAtTime(0, now+ms/1000);
    setTimeout(()=>{ try{o.stop();}catch{} }, ms+20);
  }
  function thud(){
    if(!AC) return;
    const o=AC.createOscillator(); o.type="triangle"; const g=AC.createGain();
    o.connect(g).connect(master); const now=AC.currentTime;
    o.frequency.setValueAtTime(200,now); o.frequency.exponentialRampToValueAtTime(60, now+0.2);
    g.gain.setValueAtTime(0.5, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.25);
    o.start(); setTimeout(()=>{ try{o.stop();}catch{} }, 260);
  }

  // ---------- ゾーン ----------
  const SAFE_H = 90; // 下部セーフ高さ
  const bonus = { cx:480, cy:243, rOrbit:70, radius:48, speed:0.6 };

  function drawZones(t){
    // セーフ
    ctx.fillStyle="rgba(20,200,120,0.10)"; ctx.fillRect(0, H-SAFE_H, W, SAFE_H);
    // ボーナス
    const ang=t*bonus.speed, bx=bonus.cx+Math.cos(ang)*bonus.rOrbit, by=bonus.cy+Math.sin(ang)*bonus.rOrbit;
    ctx.fillStyle="rgba(250,210,60,0.12)";
    ctx.beginPath(); ctx.arc(bx,by,bonus.radius,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(250,210,60,0.25)"; ctx.beginPath(); ctx.arc(bonus.cx,bonus.cy,bonus.rOrbit,0,Math.PI*2); ctx.stroke();
    return {bx,by};
  }
  function inCircle(px,py,cx,cy,r){ const dx=px-cx, dy=py-cy; return dx*dx+dy*dy <= r*r; }

  // ---------- 背景（パララックス＋画像があれば合成） ----------
  const stars = [
    {n:60, s:12, sp:10, pts:[]},
    {n:40, s:18, sp:20, pts:[]},
    {n:20, s:26, sp:35, pts:[]},
  ];
  for(const layer of stars){
    for(let i=0;i<layer.n;i++){ layer.pts.push({x:Math.random()*W, y:Math.random()*H}); }
  }
  function drawBG(dtAcc){
    // グラデ
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,"#0b1020"); g.addColorStop(1,"#0f1830"); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    // 画像レイヤ（任意）
    const bg1=IMG.get("bg1"), bg2=IMG.get("bg2"), bg3=IMG.get("bg3");
    if(bg1){ const y=(dtAcc*20)%H; ctx.globalAlpha=0.7; ctx.drawImage(bg1,0,y-H,W,H); ctx.drawImage(bg1,0,y,W,H); ctx.globalAlpha=1; }
    if(bg2){ const y=(dtAcc*35)%H; ctx.globalAlpha=0.4; ctx.drawImage(bg2,0,y-H,W,H); ctx.drawImage(bg2,0,y,W,H); ctx.globalAlpha=1; }
    if(bg3){ const y=(dtAcc*55)%H; ctx.globalAlpha=0.25; ctx.drawImage(bg3,0,y-H,W,H); ctx.drawImage(bg3,0,y,W,H); ctx.globalAlpha=1; }
    // パララックススター
    ctx.fillStyle="rgba(255,255,255,0.6)";
    for(const layer of stars){
      for(const p of layer.pts){ p.y += layer.sp*0.016; if(p.y>H) p.y-=H; ctx.fillRect(p.x, p.y, 1.2, 1.2); }
    }
  }

  // ---------- ゲーム状態 ----------
  const TITLE="title", PLAY="play", OVER="over";
  const player={ x:W/2, y:H*0.8, size:26, hitR:10, speed:245, slow:0.5, vx:0, vy:0 };
  let bullets=[], state=TITLE, allowReturnAt=0, timePlay=0, score=0;

  // ---------- 弾（4種） ----------
  const timers={ rain:0, side:0, ring:0, homing:0, kanji:0 };
  function randomKanji(){ const s="炎雷風水土空光闇心愛夢星竜鬼斬破護爆迅煌零冥極華刹翔滅砲砕烈煌舞刃閃虎龍雷火光影彗".split(""); return s[(Math.random()*s.length)|0]; }

  function spawn(dt){
    timers.rain+=dt; timers.side+=dt; timers.ring+=dt; timers.homing+=dt; timers.kanji+=dt;

    // 雨（白）
    if(timers.rain>=0.15){ timers.rain=0;
      const x=20+Math.random()*(W-40);
      bullets.push({kind:"white",x,y:-10,vx:0,vy:140+Math.random()*50,r:6,alive:true});
    }
    // 横（赤）
    if(timers.side>=1.1){ timers.side=0;
      const L=Math.random()<0.5, y0=60+Math.random()*(H-220);
      for(let i=0;i<7;i++){
        bullets.push({kind:"red",x:L?-10:W+10,y:y0+i*9,vx:L?160:-160,vy:(Math.random()*2-1)*22,r:5,alive:true});
      }
    }
    // リング（白）
    if(timers.ring>=2.4){ timers.ring=0;
      const cx=80+Math.random()*(W-160), cy=80+Math.random()*(H-220), n=24, spd=135;
      for(let i=0;i<n;i++){ const a=i/n*Math.PI*2; bullets.push({kind:"white",x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:6,alive:true}); }
    }
    // 誘導（青）
    if(timers.homing>=3.6){ timers.homing=0;
      const edge=(Math.random()*4)|0; let x=0,y=0;
      if(edge===0){x=Math.random()*W;y=-10;} if(edge===1){x=W+10;y=Math.random()*H;}
      if(edge===2){x=Math.random()*W;y=H+10;} if(edge===3){x=-10;y=Math.random()*H;}
      const ang=Math.atan2(player.y-y, player.x-x), v=145;
      bullets.push({kind:"blue",x,y,vx:Math.cos(ang)*v,vy:Math.sin(ang)*v,turnDeg:120,r:6,alive:true,homing:true});
    }
    // 巨大漢字弾（緩やか追尾）
    if(timers.kanji>=5.0){ timers.kanji=0;
      const x=40+Math.random()*(W-80);
      bullets.push({kind:"kanji",x,y:-30,vx:0,vy:95,turnDeg:60,r:24,alive:true,text:randomKanji()});
    }
  }

  function update(dt){
    // プレイヤー移動
    let dx=0,dy=0;
    if(keys.has("ArrowLeft")||keys.has("a")||keys.has("A")) dx-=1;
    if(keys.has("ArrowRight")||keys.has("d")||keys.has("D")) dx+=1;
    if(keys.has("ArrowUp")||keys.has("w")||keys.has("W")) dy-=1;
    if(keys.has("ArrowDown")||keys.has("s")||keys.has("S")) dy+=1;
    if(pointerDown){ player.x+=(pointerX-player.x)*0.35; player.y+=(pointerY-player.y)*0.35; player.vx= (pointerX-player.x); player.vy=(pointerY-player.y); }
    else if(dx||dy){ const len=Math.hypot(dx,dy)||1; const v=player.speed*((keys.has("Shift")||keys.has(" "))?player.slow:1);
      const vx=(dx/len)*v, vy=(dy/len)*v; player.x+=vx*dt; player.y+=vy*dt; player.vx=vx; player.vy=vy; }
    player.x=Math.max(0,Math.min(W,player.x)); player.y=Math.max(0,Math.min(H,player.y));

    // 弾
    spawn(dt);
    for(const b of bullets){
      if(b.homing){
        const angTo=Math.atan2(player.y-b.y, player.x-b.x);
        const cur=Math.atan2(b.vy,b.vx);
        const max=(b.turnDeg*Math.PI/180)*dt;
        let diff=angTo-cur; while(diff>Math.PI) diff-=Math.PI*2; while(diff<-Math.PI) diff+=Math.PI*2;
        diff=Math.max(-max,Math.min(max,diff));
        const next=cur+diff; const sp=Math.hypot(b.vx,b.vy)||145;
        b.vx=Math.cos(next)*sp; b.vy=Math.sin(next)*sp;
      } else if (b.kind==="kanji"){
        // 緩やか追尾
        const angTo=Math.atan2(player.y-b.y, player.x-b.x);
        const cur=Math.atan2(b.vy,b.vx);
        const max=(b.turnDeg*Math.PI/180)*dt;
        let diff=angTo-cur; while(diff>Math.PI) diff-=Math.PI*2; while(diff<-Math.PI) diff+=Math.PI*2;
        diff=Math.max(-max,Math.min(max,diff));
        const next=cur+diff; const sp=Math.hypot(b.vx,b.vy)||110;
        b.vx=Math.cos(next)*sp; b.vy=Math.sin(next)*sp;
      }
      b.x+=b.vx*dt; b.y+=b.vy*dt;
      if(b.x<-80||b.x>W+80||b.y<-80||b.y>H+80) b.alive=false;
    }
    bullets=bullets.filter(b=>b.alive);

    // 当たり
    for(const b of bullets){
      const rr=(b.r+player.hitR), dx=b.x-player.x, dy=b.y-player.y;
      if(dx*dx+dy*dy<=rr*rr) return true;
    }
    return false;
  }

  // ---------- 描画 ----------
  function drawPlayer(){
    const img=IMG.get("player");
    const ang=Math.atan2(player.vy, player.vx)||0;
    ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(ang);
    const s=player.size;
    if(img){ ctx.drawImage(img, -s, -s, s*2, s*2); }
    else {
      // フォールバック：ダイヤ＋グロー
      ctx.shadowColor="rgba(80,200,255,0.6)"; ctx.shadowBlur=20;
      ctx.fillStyle="#4cf"; ctx.beginPath(); ctx.moveTo(0,-s); ctx.lineTo(s*0.7,0); ctx.lineTo(0,s); ctx.lineTo(-s*0.7,0); ctx.closePath(); ctx.fill();
      ctx.shadowBlur=0;
      ctx.strokeStyle="rgba(255,255,255,0.35)"; ctx.beginPath(); ctx.arc(0,0,player.hitR,0,Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }
  function drawBullets(){
    for(const b of bullets){
      if(b.kind==="white"){ const sp=IMG.get("b_white"); if(sp) ctx.drawImage(sp,b.x-b.r,b.y-b.r,b.r*2,b.r*2); else { ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); } }
      else if(b.kind==="red"){ const sp=IMG.get("b_red"); if(sp) ctx.drawImage(sp,b.x-b.r,b.y-b.r,b.r*2,b.r*2); else { ctx.fillStyle="#f55"; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); } }
      else if(b.kind==="blue"){ const sp=IMG.get("b_blue"); if(sp) ctx.drawImage(sp,b.x-b.r,b.y-b.r,b.r*2,b.r*2); else { ctx.fillStyle="#6cf"; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); } }
      else if(b.kind==="kanji"){
        const sp=IMG.get("b_kanji");
        ctx.save(); ctx.translate(b.x,b.y);
        ctx.fillStyle="rgba(255,255,255,0.12)"; ctx.beginPath(); ctx.arc(0,0,b.r,0,Math.PI*2); ctx.fill();
        if(sp) ctx.drawImage(sp, -b.r, -b.r, b.r*2, b.r*2);
        ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.font="bold 20px Noto Sans JP, sans-serif"; ctx.fillText(b.text||"炎",0,2);
        ctx.fillStyle="#f55"; ctx.font="10px Noto Sans JP, sans-serif"; ctx.fillText("アツイ",0,-b.r+10);
        ctx.restore();
      }
    }
  }
  function drawTitle(){ ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.font="64px Orbitron, sans-serif"; ctx.fillText("TAMAYOKE 2", W/2, H*0.33);
    ctx.font="18px Noto Sans JP, sans-serif"; ctx.fillText("クリック／Enter でスタート", W/2, H*0.33+56);
  }
  function drawGameOver(){ ctx.font="46px Orbitron, sans-serif"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillStyle="#ff9"; ctx.fillText("GAME OVER", W/2, H*0.35); ctx.font="18px Noto Sans JP, sans-serif"; ctx.fillStyle="#fff"; ctx.fillText("0.7秒後に クリック／Enter でタイトルへ", W/2, H*0.35+50); }
  function drawScore(){ const s=String(score|0).padStart(6,"0"); ctx.font="20px Orbitron, monospace"; ctx.textAlign="right"; ctx.textBaseline="top"; ctx.fillStyle="#fff"; ctx.fillText(`SCORE  ${s}`, W-16, 12); }

  // ---------- 送信（初回必ず・以降ベスト時） ----------
  const SUBMITTED_KEY="rankSubmittedOnce";
  async function submitScore(finalScore){
    if(!rank.enabled) return;
    const already = localStorage.getItem(SUBMITTED_KEY)==="1";
    const best = loadBest();
    const mustSubmit = !already;
    const isBest = (finalScore|0) > best;
    if(!mustSubmit && !isBest) return;
    if(isBest) saveBest(finalScore|0);

    let name = loadPlayerName();
    if(!name){ name=(prompt("名前（16文字まで）を入力してください","YOU")||"YOU").trim().slice(0,16); savePlayerName(name); }

    const prev=elLB.textContent; elLB.textContent="SUBMITTING...";
    const res=await rank.submit(name, finalScore|0);
    if(res.status==="ok"){ localStorage.setItem(SUBMITTED_KEY,"1"); await renderLeaderboard(); beep(1320,120,0.35); }
    else { console.error(res.error||"submit failed"); elLB.textContent=prev||"通信エラー"; }
  }

  // ---------- ループ ----------
  let prev=performance.now(), tAccum=0;
  bl("title ready");
  requestAnimationFrame(function loop(ts){
    const dt=Math.min(1/20, Math.max(0,(ts-prev)/1000)); prev=ts; tAccum+=dt;

    drawBG(tAccum);
    const {bx,by}=drawZones(tAccum);

    if(state===TITLE){
      drawTitle();
      if(keys.has("Enter")||pointerDown){ pointerDown=false; state=PLAY; timePlay=0; score=0; bullets.length=0; padCrossTo("play"); }
    }else if(state===PLAY){
      timePlay+=dt; const bonusOn = inCircle(player.x,player.y,bx,by,bonus.radius);
      score += (bonusOn?4:1)*10*dt;
      if(update(dt)){ const fs=score|0; thud(); submitScore(fs).catch(()=>{}); state=OVER; allowReturnAt=performance.now()+700; bullets.length=0; padCrossTo("title"); }
      drawBullets(); drawPlayer(); drawScore();
    }else{ // OVER
      drawBullets(); drawGameOver(); drawScore();
      if(performance.now()>=allowReturnAt && (keys.has("Enter")||pointerDown)){ pointerDown=false; state=TITLE; timePlay=0; }
    }

    requestAnimationFrame(loop);
  });

  // 初期BGM（タイトル）
  padCrossTo("title");
}
</script>
</body>
</html>
