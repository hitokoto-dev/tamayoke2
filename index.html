<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Diag</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;font-family:system-ui, -apple-system, "Noto Sans JP", sans-serif;background:#000;color:#fff}
  pre{white-space:pre-wrap; word-break:break-word; background:#111; padding:12px; border-radius:8px}
  .ok{color:#9f9} .ng{color:#f99}
  .row{margin:10px 0}
  canvas{display:block;margin:16px auto;border:1px solid #333}
</style>
</head>
<body>
<h2 style="padding:12px 16px">診断モード</h2>
<div class="row" id="u"></div>
<div class="row"><b>チェック結果</b></div>
<div class="row" id="r1"></div>
<div class="row" id="r2"></div>
<div class="row" id="r3"></div>
<div class="row" id="r4"></div>
<div class="row"><b>エラー</b></div>
<pre id="err">(まだありません)</pre>
<canvas id="cv" width="960" height="540"></canvas>
<script>
(async () => {
  const log = (el, ok, msg) => el.innerHTML =
    (ok ? '<span class="ok">✔</span> ' : '<span class="ng">✖</span> ') + msg;

  document.getElementById('u').textContent = location.href;

  // 1) config/game.json の取得
  let conf, ok1=false;
  try {
    const res = await fetch("./config/game.json?v="+Date.now());
    log(r1, res.ok, `config/game.json → ${res.status}`);
    conf = res.ok ? await res.json() : null;
    ok1 = res.ok;
  } catch(e){ log(r1,false,"config 取得エラー"); err.textContent = e.stack || e; }

  // 2) js/main.js の存在チェック（ロードはしない）
  try {
    const res = await fetch("./js/main.js?v="+Date.now());
    log(r2, res.ok, `js/main.js → ${res.status}`);
  } catch(e){ log(r2,false,"main.js 取得エラー"); err.textContent = e.stack || e; }

  // 3) 背景画像パス
  if (conf?.background?.image) {
    try {
      const res = await fetch(conf.background.image+"?v="+Date.now());
      log(r3, res.ok, `background: ${conf.background.image} → ${res.status}`);
    } catch(e){ log(r3,false,"背景画像 取得エラー"); err.textContent = e.stack || e; }
  } else {
    log(r3,false,"config.background.image 未設定");
  }

  // 4) BGM1本テスト（normalの先頭）
  if (conf?.audio?.bgm?.normal?.src?.length) {
    const url = conf.audio.bgm.normal.src.slice(-1)[0]; // mp3想定
    try {
      const res = await fetch(url+"?v="+Date.now());
      log(r4, res.ok, `audio: ${url} → ${res.status}`);
    } catch(e){ log(r4,false,"audio 取得エラー"); err.textContent = e.stack || e; }
  } else {
    log(r4,false,"config.audio.bgm.normal.src 未設定");
  }

  // 5) 画面が真っ黒でない確認（キャンバス描画）
  const cv = document.getElementById('cv');
  const g = cv.getContext('2d');
  g.fillStyle = "#222"; g.fillRect(0,0,cv.width,cv.height);
  g.fillStyle = "#fff"; g.font = "28px system-ui";
  g.fillText("診断キャンバス OK", 24, 48);
})();
</script>
</body>
</html>
