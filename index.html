<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Bullet Dodge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;background:#000;color:#fff}
    canvas{display:block;margin:auto}
    #err{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.9)}
    #err pre{max-width:960px;white-space:pre-wrap;word-break:break-word;background:#111;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <canvas id="game" width="960" height="540"></canvas>
  <div id="err"><pre id="errtxt"></pre></div>

  <script type="module">
    // ★ここを変えるだけで、すべてのモジュール/画像/音源のキャッシュを確実に更新
    const V = "ui-gameover-freeze-4";
    window.__APP_VERSION__ = V; // 音や画像のfetchでも同じVを付ける

    const showErr = (e) => {
      const box = document.getElementById('err');
      const pre = document.getElementById('errtxt');
      pre.textContent = (e && e.stack) ? e.stack : String(e);
      box.style.display = 'flex';
      console.error(e);
    };
    window.addEventListener('error', ev => showErr(ev.error || ev.message));
    window.addEventListener('unhandledrejection', ev => showErr(ev.reason || ev));

    const withV = (src) => src + (src.includes("?") ? "&" : "?") + "v=" + V;

    (async () => {
      try {
        const res = await fetch(withV("./config/game.json"), { cache: "no-store" });
        if (!res.ok) throw new Error("config fetch failed: " + res.status + " " + res.statusText);
        const conf = await res.json();
        await document.fonts.ready;

        const mod = await import(withV("./js/main.js"));
        mod.boot(conf, V);
      } catch (e) {
        showErr(e);
      }
    })();
  </script>
</body>
</html>
